<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerekasztal Rating</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .add-row-button, .tab-button {
            margin-top: 10px;
            padding: 8px 15px;
            cursor: pointer;
        }
        .delete-button {
            padding: 5px 10px;
            cursor: pointer;
        }
        .name-select, .rating-input {
            padding: 5px;
        }
        .tab-content {
            display: none; /* Kezdetben rejtett */
            margin-top: 20px;
        }
        .tab-content.active {
            display: block; /* Aktív fül tartalma látható */
        }
        .tabs {
            margin-bottom: 10px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script type="module" src="firebase.js"></script>
</head>
<body>

    <h1>Kerekasztal Rating</h1>

    <div class="tabs">
        <button class="tab-button active" onclick="openTab('rating')">Rating</button>
        <button class="tab-button" onclick="openTab('rangsor')">Rangsor</button>
    </div>

    <div id="rating" class="tab-content active">
        <h2>Értékelések</h2>
        <table id="ratingTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Név</th>
                    <th>Előadó</th>
                    <th>Albumcím</th>
                    <th>Átlag</th>
                    <th>Bálint</th>
                    <th>Szabber</th>
                    <th>Ivanics</th>
                    <th>Rásó</th>
                    <th>Bakos</th>
                    <th>Gaben</th>
                    <th>Kolos</th>
                    <th>Műveletek</th>
                </tr>
            </thead>
            <tbody id="ratingTableBody">
            </tbody>
        </table>
        <button class="add-row-button" onclick="addRow()">Új sor hozzáadása</button>
    </div>

    <div id="rangsor" class="tab-content">
        <h2>Album Rangsor</h2>
        <table id="rangsorTable">
            <thead>
                <tr>
                    <th>Helyezés</th>
                    <th>Albumcím</th>
                    <th>Átlagpontszám</th>
                </tr>
            </thead>
            <tbody id="rangsorTableBodyRangsor">
            </tbody>
        </table>
    </div>

    <script type="module">
        import { db } from './firebase.js'; // Importáld a db objektumot a firebase.js-ből

        const ratingTableBody = document.getElementById('ratingTableBody');
        const rangsorTableBodyRangsor = document.getElementById('rangsorTableBodyRangsor');
        const defaultNames = ['Bálint', 'Szabber', 'Ivanics', 'Rásó', 'Bakos', 'Gaben'];
        const allNames = [...defaultNames, 'Kolos'];
        const nameColors = {
            'Bálint': '#F4B084',
            'Szabber': '#9BC2E6',
            'Ivanics': '#A9D08E',
            'Rásó': '#8EA9DB',
            'Bakos': '#FFD966',
            'Gaben': '#C9C9C9',
            'Kolos': '#C00000'
        };
        let defaultNameIndex = 0;
        let rowCounter = 1; // Sorszám számláló

        function openTab(tabId) {
            const tabContents = document.querySelectorAll('.tab-content');
            const tabButtons = document.querySelectorAll('.tab-button');
            tabContents.forEach(content => content.classList.remove('active'));
            tabButtons.forEach(button => button.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="openTab('${tabId}')"]`).classList.add('active');
            if (tabId === 'rangsor') {
                updateRangsorTable();
            }
        }

        function loadDataFromFirestore() {
            ratingTableBody.innerHTML = ''; // Táblázat ürítése betöltés előtt
            db.collection("ratings").orderBy('sorszam') // Rendezés a 'sorszam' mező szerint
                .get()
                .then((querySnapshot) => {
                    rowCounter = 1; // Reset számláló betöltéskor
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        addRowToTable(data, doc.id, data.sorszam); // A sorszámot a Firestore-ból olvassuk
                    });
                    updateRangsorTable();
                })
                .catch((error) => {
                    console.error("Hiba történt az adatok lekérésekor a Firestore-ból: ", error);
                });
        }

        function saveDataToFirestore(rowData, docId) {
            return db.collection("ratings").doc(docId).set(rowData)
                .then(() => {
                    console.log("Adatok sikeresen mentve a Firestore-ba!");
                })
                .catch((error) => {
                    console.error("Hiba történt a Firestore-ba mentéskor: ", error);
                });
        }

        function deleteDataFromFirestore(docId) {
            return db.collection("ratings").doc(docId).delete()
                .then(() => {
                    console.log(`A(z) ${docId} ID-jű értékelés sikeresen törölve!`);
                }).catch((error) => {
                    console.error("Hiba történt a Firestore-ból törléskor: ", error);
                });
        }

        function addRowToTable(rowData, docId, sorszam) {
            const newRow = ratingTableBody.insertRow();
            newRow.dataset.docId = docId; // Tároljuk a dokumentum ID-t a sorban
            const cells = [];
            for (let i = 0; i < 13; i++) {
                cells.push(newRow.insertCell());
            }
            cells[0].textContent = sorszam; // Sorszám cella
            cells[4].textContent = rowData.average || ''; // Átlag cella

            // Név legördülő menü
            const nameSelect = document.createElement('select');
            nameSelect.classList.add('name-select');
            defaultNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                nameSelect.appendChild(option);
            });
            const kolosOption = document.createElement('option');
            kolosOption.value = 'Kolos';
            kolosOption.textContent = 'Kolos';
            nameSelect.appendChild(kolosOption);
            nameSelect.value = rowData.name || defaultNames[defaultNameIndex % defaultNames.length];
            nameSelect.addEventListener('change', function() {
                applyRowColor(newRow);
                updateRowData(newRow, docId);
            });
            cells[1].appendChild(nameSelect);

            cells[2].innerHTML = `<input type="text" value="${rowData.artist || ''}">`;
            cells[3].innerHTML = `<input type="text" value="${rowData.album || ''}">`;
            cells[3].querySelector('input').addEventListener('change', () => updateRowData(newRow, docId));

            // Értékelési oszlopok
            for (let i = 0; i < allNames.length; i++) {
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '1';
                input.max = '10';
                input.step = '0.5';
                input.classList.add('rating-input');
                input.value = rowData.ratings ? (rowData.ratings[i] !== undefined ? rowData.ratings[i] : '') : '';
                input.addEventListener('change', () => {
                    calculateAverage(newRow);
                    updateRowData(newRow, docId);
                });
                cells[i + 5].appendChild(input);
            }

            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-button');
            deleteButton.textContent = 'Törlés';
            deleteButton.addEventListener('click', () => deleteRow(deleteButton));
            cells[12].appendChild(deleteButton);

            applyRowColor(newRow);
            calculateAverage(newRow);
            defaultNameIndex++;
        }

        function addRow() {
            const newRowData = {
                name: defaultNames[defaultNameIndex % defaultNames.length],
                artist: '',
                album: '',
                ratings: Array(allNames.length).fill(''),
                sorszam: rowCounter // Hozzáadjuk a sorszámot az új adatokhoz
            };
            db.collection("ratings").add(newRowData) // Firestore automatikusan generál egy ID-t
                .then((docRef) => {
                    console.log("Dokumentum ID: ", docRef.id);
                    addRowToTable(newRowData, docRef.id, rowCounter++);
                })
                .catch((error) => {
                    console.error("Hiba történt a Firestore-ba mentéskor: ", error);
                });
            defaultNameIndex++;
        }

        function deleteRow(button) {
            const row = button.parentNode.parentNode;
            const docId = row.dataset.docId;
            if (docId) {
                deleteDataFromFirestore(docId).then(() => {
                    row.remove();
                    updateRangsorTable();
                    loadDataFromFirestore(); // Újratöltjük az adatokat a sorszám szerinti sorrendhez
                });
            } else {
                row.remove();
                updateRangsorTable();
                loadDataFromFirestore(); // Újratöltjük az adatokat a sorszám szerinti sorrendhez
            }
        }

        function updateRowData(row, docId) {
            const nameSelect = row.cells[1].querySelector('select');
            const artistInput = row.cells[2].querySelector('input');
            const albumInput = row.cells[3].querySelector('input');
            const ratings = [];
            for (let i = 5; i < row.cells.length - 1; i++) {
                const input = row.cells[i].querySelector('input[type="number"]');
                ratings.push(input ? input.value : '');
            }

            const rowData = {
                sorszam: parseInt(row.cells[0].textContent), // Megtartjuk a sorszámot
                name: nameSelect.value,
                artist: artistInput.value,
                album: albumInput.value,
                ratings: ratings,
                average: parseFloat(row.cells[4].textContent) || ''
            };

            saveDataToFirestore(rowData, docId);
        }

        function applyRowColor(row) {
            const nameCell = row.cells[1].querySelector('select');
            if (nameCell && nameCell.value) {
                const name = nameCell.value;
                for (let i = 1; i <= 3; i++) {
                    if (row.cells[i]) {
                        row.cells[i].style.backgroundColor = nameColors[name] || '';
                    }
                }
                for (let i = 5; i < row.cells.length; i++) {
                    if (row.cells[i]) {
                        row.cells[i].style.backgroundColor = '';
                    }
                }
                row.cells[4].style.backgroundColor = '';
            } else {
                for (let i = 1; i <= 3; i++) {
                    if (row.cells[i]) {
                        row.cells[i].style.backgroundColor = '';
                    }
                }
                row.cells[4].style.backgroundColor = '';
            }
        }

        function calculateAverage(row) {
            let sum = 0;
            let count = 0;
            for (let i = 5; i < row.cells.length - 1; i++) {
                const input = row.cells[i].querySelector('input[type="number"]');
                if (input && input.value !== '') {
                    sum += parseFloat(input.value);
                    count++;
                }
            }
            const averageCell = row.cells[4];
            averageCell.textContent = count > 0 ? (sum / count).toFixed(2) : '';
        }

        function updateRangsorTable() {
            const albumRatings = {};
            for (let i = 0; i < ratingTableBody.rows.length; i++) {
                const row = ratingTableBody.rows[i];
                const albumTitleInput = row.cells[3].querySelector('input[type="text"]');
                const averageCell = row.cells[4];
                if (albumTitleInput && albumTitleInput.value && averageCell.textContent) {
                    const albumTitle = albumTitleInput.value;
                    const averageScore = parseFloat(averageCell.textContent);
                    albumRatings[albumTitle] = albumRatings[albumTitle] || [];
                    albumRatings[albumTitle].push(averageScore);
                }
            }

            const albumAverages = [];
            for (const album in albumRatings) {
                const sum = albumRatings[album].reduce((a, b) => a + b, 0);
                const avg = sum / albumRatings[album].length;
                albumAverages.push({ title: album, average: avg });
            }

            albumAverages.sort((a, b) => b.average - a.average);

            rangsorTableBodyRangsor.innerHTML = '';
            albumAverages.forEach((album, index) => {
                const newRow = rangsorTableBodyRangsor.insertRow();
                const rankCell = newRow.insertCell();
                const titleCell = newRow.insertCell();
                const averageCell = newRow.insertCell();
                rankCell.textContent = index + 1;
                titleCell.textContent = album.title;
                averageCell.textContent = album.average.toFixed(2);
            });
        }

        // Kezdetben az adatok betöltése
        loadDataFromFirestore();
    </script>

</body>
</html>
